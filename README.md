# Pop-in Protocol Stack

## 개요
Pop-in은 팝업스토어를 위한 스마트 체험 관리 플랫폼입니다. RSSI 기반 자동 부스 탐색과 실시간 대기열 관리를 통해 효율적인 팝업스토어 운영을 지원합니다.

## 시스템 아키텍처

### 프로토콜 스택
```
Application Layer  - Pop-in 애플리케이션 로직
L3 Layer          - 메시지 처리, FSM 관리, 세션 제어
L2 Layer          - Stop-and-Wait ARQ, 데이터 분할/조립
PHY/MAC Layer     - LoRa 무선 통신, RSSI/SNR 측정
```

### FSM 기반 상태 관리
- **사용자**: SCANNING → CONNECTED → WAITING/IN_USE → SCANNING
- **관리자**: 항상 IN_USE 상태에서 부스 운영

## 핵심 기술

### 1. RSSI 기반 부스 선택
```
Score = RSSI + (빈자리 보너스) - (대기인원 × 10)
```
- 신호 강도를 주요 지표로 활용
- 부스 상태를 보조 지표로 고려
- 2초 스캔 후 최적 부스 자동 선택

### 2. Pull 기반 대기열 시스템
- **서버 주도형**: 관리자가 다음 대기자 호출
- **위치 기반**: 10초 내 부스 근처에서 응답 필요
- **자동 스킵**: 무응답 시 다음 대기자로 이동
- **실시간 업데이트**: 순번 변경 시 모든 대기자에게 알림

### 3. Push-to-Talk 채팅
- **키 기반 활성화**: 'c' 키로 채팅 모드 진입
- **Star Topology**: 관리자가 메시지 중계
- **부스별 격리**: 같은 부스 내 사용자끼리만 통신
- **발신자 ID 보존**: 투명한 메시지 전달

### 4. 신뢰성 메커니즘
- **L2 ARQ**: 최대 10회 재전송, 1-3초 적응형 타임아웃
- **L3 재시도**: 연결/등록 실패 시 3회 재시도
- **중복 필터링**: 메시지 시퀀스 번호 기반 중복 제거
- **타임아웃 관리**: 연결(3초), 대기열 응답(10초), 세션(100초)

## 주요 기능

### 사용자 기능
- **자동 부스 탐색**: RSSI 기반 최적 부스 선택
- **체험 관리**: 100초 세션, 1인 1회 제한
- **대기열**: 실시간 순번 확인, 입장 알림
- **채팅**: Push-to-Talk 방식 실시간 채팅
- **조기 퇴장**: 'e' 키로 즉시 퇴장

### 관리자 기능
- **부스 운영**: 자동 방송, Quiet 모드
- **사용자 관리**: 세션 타이머, 대기열 관리
- **메시지 전송**: 공지사항, 채팅 중계
- **상태 모니터링**: 실시간 부스 현황 확인

## 프로토콜 메시지

### 메시지 구조
```
[MSG_TYPE(1byte)][DATA(가변)]
```

### 주요 메시지 타입
- **탐색**: BOOTH_SCAN(0x0E), BOOTH_ANNOUNCE(0x0F)
- **연결**: CONNECT_REQUEST(0x02), BOOTH_INFO(0x04)
- **등록**: REGISTER_REQUEST(0x06), REGISTER_RESPONSE(0x07)
- **대기열**: QUEUE_INFO(0x09), QUEUE_READY(0x11), QUEUE_UPDATE(0x13)
- **세션**: EXIT_REQUEST(0x0A), TIMEOUT_ALERT(0x0B)
- **통신**: ADMIN_MESSAGE(0x0C), CHAT_MESSAGE(0x0D)

## 시스템 파라미터
```c
MAX_BOOTH_CAPACITY    2      // 부스 최대 수용 인원
MAX_USERS            20      // 최대 사용자 수
SESSION_DURATION_MS  100000  // 세션 시간 (100초)
ADMIN_ID_START       1       // 관리자 ID 시작
ADMIN_ID_END         3       // 관리자 ID 끝
```

## 사용 방법

### 관리자 (ID: 1-3)
```
1. 프로그램 실행 후 ID 1-3 입력
2. 자동으로 부스 운영 시작
3. 키보드 명령:
   m - 메시지 전송    s - 상태 확인
   a - 공지 전송      q - Quiet 모드
   t - 타이머 확인    w - 대기열 확인
```

### 사용자 (ID: 4+)
```
1. 프로그램 실행 후 ID 4 이상 입력
2. 자동 부스 탐색 및 연결
3. 부스 체험:
   y/n - 체험 여부 선택
   c - 채팅 시작
   e - 퇴장/대기열 이탈
```

## 기술 스택
- **플랫폼**: mbed OS (STM32 NUCLEO-F446RE)
- **통신**: LoRa 무선 통신
- **언어**: C++
- **아키텍처**: Event-driven FSM