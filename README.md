# Pop-in Protocol Stack

## 📋 개요
Pop-in은 팝업스토어를 위한 스마트 체험 관리 플랫폼입니다. RSSI 기반 자동 부스 탐색과 실시간 대기열 관리를 통해 효율적인 팝업스토어 운영을 지원합니다.

## 🎯 주요 특징
- **RSSI 기반 자동 부스 탐색**: 신호 강도를 기반으로 최적의 부스 자동 선택
- **실시간 대기열 관리**: 자동 순번 관리 및 입장 알림
- **1인 1회 체험 정책**: 공정한 체험 기회 보장
- **세션 타이머**: 시간 제한을 통한 효율적인 운영

## 🛠️ 구현된 기능

### 1. 사용자 (User) 기능

#### 부스 탐색 및 연결
- ✅ **RSSI 기반 자동 부스 스캔**
  - 2초 주기로 주변 부스 자동 탐색
  - 신호 강도(RSSI) 측정 및 표시
- ✅ **최적 부스 선택 알고리즘**
  - RSSI 신호 강도 (주요 요소)
  - 부스 가용성 (보너스 점수)
  - 대기 인원 (패널티 점수)
- ✅ **자동 연결 시도**
  - 연결 실패 시 최대 3회 재시도
  - 타임아웃 관리 (3초)

#### 부스 체험 관리
- ✅ **체험 등록 및 입장**
  - 부스 정보 확인 후 선택적 입장
  - 만석 시 자동 대기열 등록
- ✅ **세션 타이머**
  - 40초 체험 시간 제한
  - 5초마다 남은 시간 표시
  - 시간 만료 시 자동 퇴장
- ✅ **수동 퇴장** ('e' 키)
  - 체험 중 조기 퇴장 가능
  - 대기 중 대기열 이탈 가능
- ✅ **재입장 차단**
  - 1인 1회 체험 정책 적용
  - 이미 체험한 부스 재등록 불가

#### 대기열 관리
- ✅ **자동 대기열 등록**
  - 부스 만석 시 자동으로 대기열 추가
  - 실시간 대기 순번 표시
- ✅ **입장 알림 시스템**
  - 순서 도래 시 자동 알림
  - 10초 내 응답 필요
  - 미응답 시 자동 제외
- ✅ **대기열 업데이트**
  - 순번 변경 시 실시간 알림
  - 대기열 이탈 기능

#### 커뮤니케이션
- ✅ **관리자 메시지 수신**
  - 체험 중인 사용자만 메시지 수신
  - 실시간 공지사항 확인

### 2. 관리자 (Admin) 기능

#### 부스 운영 관리
- ✅ **자동 부스 브로드캐스트**
  - 주기적으로 부스 정보 송신
  - 현재 인원 및 대기 상태 포함
- ✅ **Quiet 모드** ('q' 키)
  - 자동 브로드캐스트 일시 중지
  - 수동 공지는 계속 가능

#### 사용자 관리
- ✅ **실시간 부스 상태 확인** ('s' 키)
  - 현재 체험 중인 사용자
  - 대기열 상태
  - 전체 등록 이력
- ✅ **세션 타이머 모니터링** ('t' 키)
  - 각 사용자별 남은 시간 확인
  - 만료 임박 경고 표시
- ✅ **대기열 관리** ('w' 키)
  - 대기 중인 사용자 목록
  - 입장 대기 타이머 상태

#### 커뮤니케이션
- ✅ **관리자 메시지 전송** ('m' 키)
  - 체험 중인 사용자에게만 전송
  - 최대 100자 메시지
- ✅ **수동 공지 전송** ('a' 키)
  - 부스 정보 즉시 브로드캐스트
- ✅ **도움말** ('h' 키)
  - 관리자 명령어 목록 표시

### 3. 프로토콜 기능

#### 통신 방식
- ✅ **양방향 통신**
  - Request-Response 패턴
  - 이벤트 기반 메시지 처리
- ✅ **브로드캐스트/유니캐스트**
  - 부스 공지: 브로드캐스트 (ID: 255)
  - 개별 통신: 유니캐스트

#### 메시지 타입
- ✅ **부스 탐색**
  - `BOOTH_SCAN` (0x0E): 부스 검색 요청
  - `BOOTH_ANNOUNCE` (0x0F): 부스 정보 응답
- ✅ **연결 관리**
  - `CONNECT_REQUEST` (0x02): 연결 요청
  - `BOOTH_INFO` (0x04): 상세 정보 응답
- ✅ **등록 처리**
  - `REGISTER_REQUEST` (0x06): 등록 요청
  - `REGISTER_RESPONSE` (0x07): 등록 결과
- ✅ **대기열 관리**
  - `QUEUE_INFO` (0x09): 대기 정보
  - `QUEUE_READY` (0x11): 입장 준비 알림
  - `QUEUE_UPDATE` (0x13): 순번 업데이트
  - `QUEUE_LEAVE` (0x14): 대기열 이탈
- ✅ **세션 관리**
  - `EXIT_REQUEST` (0x0A): 퇴장 요청
  - `TIMEOUT_ALERT` (0x0B): 시간 만료 알림
- ✅ **커뮤니케이션**
  - `ADMIN_MESSAGE` (0x0C): 관리자 메시지
  - `CHAT_MESSAGE` (0x0D): 사용자 채팅 (미구현)

#### 신호 처리
- ✅ **RSSI 측정 및 활용**
  - 실시간 신호 강도 측정
  - 부스 선택 알고리즘에 활용
- ✅ **SNR 정보 수집**
  - 신호 품질 모니터링

### 4. 안정성 기능

#### 오류 처리
- ✅ **연결 재시도**
  - 최대 3회 자동 재시도
  - 지수 백오프 적용
- ✅ **타임아웃 관리**
  - 연결 타임아웃: 3초
  - 대기열 응답: 10초
- ✅ **중복 방지**
  - 메시지 중복 필터링
  - 대기열 중복 등록 방지

#### 상태 관리
- ✅ **FSM 기반 상태 관리**
  - SCANNING → CONNECTED → WAITING/IN_USE
  - 명확한 상태 전이 규칙
- ✅ **메모리 관리**
  - 최대 사용자 수 제한 (20명)
  - 버퍼 오버플로우 방지

## 📊 시스템 제한사항
- 부스 최대 수용 인원: 1명
- 최대 대기 인원: 20명
- 세션 시간: 40초
- 메시지 최대 길이: 100자
- 지원 부스 수: 3개 (ID: 1-3)

## 🚀 사용 방법

### 관리자 (부스)
1. 프로그램 실행 후 ID 1-3 입력
2. 자동으로 부스 운영 시작
3. 키보드 명령으로 관리

### 사용자
1. 프로그램 실행 후 ID 4 이상 입력
2. 자동으로 부스 탐색 시작
3. 부스 선택 및 체험

## 🔧 기술 스택
- **플랫폼**: mbed (STM32 NUCLEO-F446RE)
- **통신**: LoRa 기반 무선 통신
- **프로토콜**: 자체 개발 L2/L3 계층
- **언어**: C++